<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8" />
  <title>Fret position Calculator | Fido Lab</title>
  <meta name="author" content="Martin Fido" />
  <meta name="description"
    content="A temperament calculator and fret position calculator for stringed instruments" />
  <link rel="SHORTCUT ICON" href="../favicon.ico" />
  <link rel="stylesheet" type="text/css" href="../css/fidolab.css">
  <script type="text/javascript" src="../js/util.js"></script>
  <script type="text/javascript" src="../js/temperament.js"></script>
  <script type="text/javascript">

    function get_notes() {
      let temperament = document.getElementById('tm').value;
      switch (temperament) {
        case 'equ': return equal_temperament();
        case 'mea': return meantone_temperament();
        case 'val': return Temperament.vallotti();
        case 'yo1': return Temperament.young_1();
        case 'yo2': return Temperament.young_2();
        case 'leh': return Temperament.bach_lehman_1722();
        case 'we3': return Temperament.werckmeister_3();
        case 'tf1': return Temperament.thidell_formula_1();
        case 'rev': return Temperament.revelation();
        case 'pyt': return Temperament.pythagorean();
        default: return custom_temperament();
      }
    }

    function meantone_temperament() {
      let comma = document.getElementById('comma').value == 's' ? Note.syntonic_comma : Note.pythagorean_comma;
      let division = 1 / document.getElementById('division').value;
      return Temperament.meantone(comma, division);
    }

    function equal_temperament() {
      let notes_per_octave = document.getElementById('npo').value;
      if (isNaN(notes_per_octave) || (notes_per_octave < 1)) {
        return [];
      }
      return Temperament.equal(notes_per_octave);
    }

    function custom_temperament() {
      let notes_str = document.getElementById('cs').value;
      return Temperament.custom(notes_str);
    }

    // TODO move to Temperament
    function shift_notes(notes, first_name) {
      let first_index = find_note_index(notes, first_name);
      if (first_index <= 0) return notes;
      let offset = notes[first_index].ratio;
      let shifted = [];
      for (let i = first_index; i < notes.length; i++) {
        shifted.push(notes[i].subtract_ratio(offset));
      }
      for (let i = 0; i < first_index; i++) {
        shifted.push(notes[i].subtract_ratio(offset));
      }
      return shifted;
    }

    function find_note_index(notes, name) {
      for (let i = 0; i < notes.length; i++) {
        let note = notes[i];
        if (note.name === name) return i;
      }
      return -1;
    }

    function find_note(notes, name) {
      for (let note of notes) {
        if (note.name === name) return note;
      }
      return null;
    }

    function update_table(notes) {
      let root_name = document.getElementById('rn').value;

      notes = shift_notes(notes, root_name);

      let cent_offset_note = find_note(notes, document.getElementById('cn').value);
      let cent_offset = document.getElementById('co').value - cent_offset_note.cents;

      let frequency_note = find_note(notes, document.getElementById('fn').value);
      let root_frequency = document.getElementById('rf').value / frequency_note.ratio;

      let scale_length = document.getElementById('sl').value;

      update_rows(notes, root_frequency, cent_offset, scale_length);
    }

    function update_rows(notes, root_frequency, cent_offset, scale_length) {
      let table = document.getElementById('frets');

      // remove all but the table header
      while (table.rows.length > 2) {
        table.deleteRow(-1);
      }

      for (let note of notes) {
        let row = table.insertRow();
        update_row(row, note, root_frequency, cent_offset, scale_length);
      }
    }

    function update_row(row, note, root_frequency, cent_offset, scale_length) {
      let cell = row.insertCell();
      cell.innerHTML = note.name;
      cell.style.textAlign = 'left';

      row.insertCell().innerHTML = note.fraction_str() || '-';
      row.insertCell().innerHTML = note.ratio_str();
      row.insertCell().innerHTML = note.cent_str(cent_offset);
      row.insertCell().innerHTML = note.cent_offset_str(cent_offset);

      cell = row.insertCell();
      if (root_frequency && !isNaN(root_frequency)) {
        cell.innerHTML = (note.ratio * root_frequency).toFixed(3);
      }

      for (let octave = 0; octave < 3; octave++) {
        cell = row.insertCell();
        if (scale_length && !isNaN(scale_length)) {
          let position = scale_length - (scale_length / (note.ratio * Math.pow(2, octave)));
          cell.innerHTML = position.toFixed(5);
        }
      }
    }

    const perma_params = ['tm', 'npo', 'cs', 'rn', 'rf', 'sl'];

    function on_temperament() {
      let sel = document.getElementById('tm').value;
      document.getElementById('ep').style.display = (sel === 'equ') ? 'block' : 'none';
      document.getElementById('mp').style.display = (sel === 'mea') ? 'block' : 'none';
      document.getElementById('cp').style.display = (sel === 'cus') ? 'block' : 'none';

      on_notes();
    }

    function on_notes() {
      let notes = get_notes();

      for (let id of [ 'rn', 'cn', 'fn' ]) {
        let fns = document.getElementById(id);
        while (fns.firstChild) {
          fns.firstChild.remove();
        }

        for (let i = 0; i < notes.length; i++) {
          let note = notes[i];
          let option = document.createElement("option");
          option.value = note.name;
          option.text = note.name;
          if ((id === 'fn') && (note.name === 'A')) {
            option.selected = 'selected';
          }
          fns.add(option);
        }
      }

      //if (document.getElementById('a').checked) {
      update_table(notes);
      //}
    }

    function on_roots() {
      let notes = get_notes();
      update_table(notes);
    }

    function on_update() {
      if (window.history.replaceState) {
        // TODO add a separate permalink button
        //window.history.replaceState({}, null, '?' + perma_query(perma_params));
      }
      on_notes();
    }

    window.onload = function () {
      let query = query_params();
      for (let i in perma_params) {
        let key = perma_params[i];
        let val = query[key];
        if ((val !== undefined) && (val !== null) && (val !== '')) {
          document.getElementById(key).value = val;
        }
      }

      on_temperament();
    }
  </script>
</head>

<body>
  <header class="fl">
    <ul>
      <li><a href="../">Fido Lab</a></li>
    </ul>
  </header>
  <noscript>
    <br />
    <div id="noscript-warning">
      <strong>
        <p>
          Sorry, this page only works on modern browsers with JavaScript enabled.
        </p>
        <p>
          If you need a new browser, you might like to try <a href="https://www.mozilla.org/firefox/">Mozilla
            Firefox</a>.
        </p>
        <p>
          If you have disabled JavaScript due to security or privacy concerns, feel free to audit my source. It's quite
          small.
        </p>
      </strong>
    </div>
  </noscript>
  <p>
    This is a temperament calculator for converting musical units (ratios, cents, frequencies) and to help
    position frets on stringed instruments.
  </p>
  <p>
    To specify your own temperament select "Custom" from the menu. Separate notes with spaces. Write e.g. "3/1" or
    "A:3/1" for ratios, and "70.6" or "D:70.6" for cents.
  </p>
  <!--<ul>
  <li>cents &equals; 1200 &times; log<sub>2</sub>(ratio)</li>
  <li>ratio &equals;2<sup>cents &divide; 1200</sup></li>
  <li>frequency &equals; root frequency &times; ratio</li>
  <li>distance from nut &equals; scale length &minus; (scale length &divide; ratio)</li>
  </ul>-->
  <p>
    Temperament:
    <select id="tm" onchange="on_temperament()">
      <option value="leh">Bach / Lehman 1722 (larips.com)</option>
      <option value="equ">Equal Temperament / Division</option>
      <option value="mea" selected="selected">Meantone</option>
      <option value="pyt">Pythagorean</option>
      <option value="rev">Revelation Tuning (michaelharrison.com)</option>
      <option value="tf1">Thidell Formula 1 (truetemperament.com)</option>
      <option value="val">Vallotti</option>
      <option value="we3">Werckmeister III</option>
      <option value="yo1">Young's first temperament</option>
      <option value="yo2">Young's second temperament</option>
      <option value="cus">Custom</option>
    </select></p>
  <p id="ep">
    Notes per Octave: <input id="npo" type="number" name="Notes per Octave" value="12" onchange="on_notes()">
  </p>
  <p id="mp" style="display: none;">
    Comma: <select id="comma" onchange="on_notes()">
      <option value="s" selected="selected">Syntonic</option>
      <option value="p">Pythagorean</option>
    </select>&nbsp;&nbsp;
    Division: <select id="division" onchange="on_notes()">
      <option value="3">1/3</option>
      <option value="3.5">2/7</option>
      <option value="4" selected="selected">1/4</option>
      <option value="5">1/5</option>
      <option value="6">1/6</option>
    </select>
  </p>
  <p id="cp" style="display: none;">
    <input id="cs" type="text" name="custom temperament" size="80"
      value="C:1/1 C♯:25/24 D:9/8 E♭:6/5 E:5/4 F:4/3 F♯:45/32 G:3/2 G♯:25/16 A:5/3 B♭:9/5 B:15/8" onchange="on_notes()">
  </p>
  <p>
    Key / Root: <select id="rn" onchange="on_roots()"></select> is 1/1
  </p>
  <p>
    Cent Offset: <select id="cn" onchange="on_roots()"></select> is <input id="co" type="text" name="cent offset" value="0" onchange="on_roots()"> cents
  </p>
  <p>
    Frequency: <select id="fn" onchange="on_roots()"></select> is <input id="rf" type="text" name="root frequency" value="440" onchange="on_roots()"> Hz
  </p>
  <p>
    Scale Length: <input id="sl" type="text" name="scale length" value="25.5" onchange="on_roots()">
  </p>
  <p>
    <input type="button" id="updatebutton" name="update" value="update" onclick="on_update()">
    <!--<input type="checkbox" id="a" name="automatically update" value="auto" onclick="on_update()"> auto update-->
  </p>
  <table id="frets">
    <tr>
      <th rowspan="2">Fret / Name</th>
      <th rowspan="2">Ratio<br /><small>(fraction)</small></th>
      <th rowspan="2">Ratio<br /><small>(decimal)</small></th>
      <th rowspan="2">Cents</th>
      <th rowspan="2">Cents<br /><small>(offset)</small></th>
      <th rowspan="2">Frequency</th>
      <th colspan="3">Distance from Nut</th>
    </tr>
    <tr>
      <th><small>first octave</small></th>
      <th><small>second octave</small></th>
      <th><small>third octave</small></th>
    </tr>
    </tr>
  </table>
</body>

</html>
